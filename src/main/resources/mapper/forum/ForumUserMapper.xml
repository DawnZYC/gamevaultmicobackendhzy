<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sg.nusiss.gamevaultbackend.mapper.forum.ForumUserMapper">

    <!-- 结果映射 -->
    <resultMap id="UserResultMap" type="ForumUser">
        <id property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="nickname" column="nickname"/>
        <result property="avatarUrl" column="avatar_url"/>
        <result property="bio" column="bio"/>
        <result property="status" column="status"/>
        <result property="createdDate" column="created_date"/>
        <result property="updatedDate" column="updated_date"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="BaseColumns">
        user_id, username, nickname, avatar_url, bio,
        status, created_date, updated_date
    </sql>

    <!-- 根据ID查询用户 -->
    <select id="findById" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- 根据用户名查询用户 -->
    <select id="findByUsername" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM users
        WHERE username = #{username}
    </select>

    <!-- 插入新用户 -->
    <insert id="insert" parameterType="ForumUser" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO users (
            username, nickname, avatar_url, bio, status, created_date, updated_date
        ) VALUES (
                     #{username}, #{nickname}, #{avatarUrl}, #{bio},
                     #{status}, #{createdDate}, #{updatedDate}
                 )
    </insert>

    <!-- 更新用户信息 -->
    <update id="update" parameterType="ForumUser">
        UPDATE users SET
                         username = #{username},
                         nickname = #{nickname},
                         avatar_url = #{avatarUrl},
                         bio = #{bio},
                         status = #{status},
                         updated_date = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
    </update>

    <!-- 检查用户名是否存在 -->
    <select id="existsByUsername" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM users
            WHERE username = #{username}
        )
    </select>

    <!-- 查询活跃用户列表 -->
    <select id="findActiveUsers" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM users
        WHERE status = 'active'
        ORDER BY created_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计活跃用户数量 -->
    <select id="countActiveUsers" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE status = 'active'
    </select>

    <!-- 批量查询用户 -->
    <select id="findByIds" resultMap="UserResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM users
        WHERE user_id IN
        <foreach item="userId" collection="userIds" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </select>

</mapper>