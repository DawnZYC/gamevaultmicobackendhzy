<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sg.nusiss.gamevaultmicobackendhzy.mapper.forum.ForumContentMapper">

    <!-- ç»“æžœæ˜ å°„ -->
    <resultMap id="ContentResultMap" type="ForumContent">
        <id property="contentId" column="content_id"/>
        <result property="contentType" column="content_type"/>
        <result property="title" column="title"/>
        <result property="body" column="body"/>
        <result property="bodyPlain" column="body_plain"/>
        <result property="authorId" column="author_id"/>
        <result property="parentId" column="parent_id"/>
        <result property="replyTo" column="reply_to"/>
        <result property="status" column="status"/>
        <result property="createdDate" column="created_date"/>
        <result property="updatedDate" column="updated_date"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="replyCount" column="reply_count"/> <!-- â† æ–°å¢žè¿™è¡Œ -->
    </resultMap>

    <!-- åŸºç¡€æŸ¥è¯¢ç‰‡æ®µ -->
    <sql id="BaseColumns">
        content_id, content_type, title, body, body_plain,
        author_id, parent_id, status, created_date, updated_date
    </sql>

    <!-- æ ¹æ®IDæŸ¥è¯¢ -->
    <select id="findById" resultMap="ContentResultMap">
        SELECT
            c.content_id,
            c.content_type,
            c.title,
            c.body,
            c.body_plain,
            c.author_id,
            c.parent_id,
            c.reply_to,
            c.status,
            c.created_date,
            c.updated_date,
            COALESCE(MAX(CASE WHEN md.metric_name = 'view_count' THEN cm.metric_value END), 0) as view_count,
            COALESCE((
                SELECT COUNT(*)
                FROM user_content_relations ucr
                WHERE ucr.content_id = c.content_id
                  AND ucr.relation_type_id = (SELECT type_id FROM relationship_types WHERE type_name = 'like')
            ), 0) as like_count,
            COALESCE(MAX(CASE WHEN md.metric_name = 'reply_count' THEN cm.metric_value END), 0) as reply_count
        FROM contents c
                 LEFT JOIN content_metrics cm ON c.content_id = cm.content_id
                 LEFT JOIN metric_definitions md ON cm.metric_id = md.metric_id
        WHERE c.content_id = #{contentId} AND c.status = 'active'
        GROUP BY c.content_id, c.content_type, c.title, c.body, c.body_plain,
                 c.author_id, c.parent_id, c.status, c.created_date, c.updated_date
    </select>

    <!-- æ’å…¥æ–°å†…å®¹ -->
    <insert id="insert" parameterType="ForumContent" useGeneratedKeys="true" keyProperty="contentId">
        INSERT INTO contents (
            content_type, title, body, body_plain, author_id, parent_id, reply_to,
            status, created_date, updated_date
        ) VALUES (
                     #{contentType}, #{title}, #{body}, #{bodyPlain}, #{authorId}, #{parentId}, #{replyTo},
                     #{status}, #{createdDate}, #{updatedDate}
                 )
    </insert>

    <!-- æ›´æ–°å†…å®¹ -->
    <update id="update" parameterType="ForumContent">
        UPDATE contents SET
                            title = #{title},
                            body = #{body},
                            body_plain = #{bodyPlain},
                            status = #{status},
                            updated_date = #{updatedDate}
        WHERE content_id = #{contentId}
    </update>

    <!-- è½¯åˆ é™¤ -->
    <update id="softDelete">
        UPDATE contents SET
                            status = 'deleted',
                            updated_date = CURRENT_TIMESTAMP
        WHERE content_id = #{contentId}
    </update>

    <!-- æŸ¥è¯¢æ´»è·ƒå¸–å­ï¼ˆåˆ†é¡µï¼‰ -->
    <select id="findActivePosts" resultMap="ContentResultMap">
        SELECT
            c.content_id,
            c.content_type,
            c.title,
            c.body,
            c.body_plain,
            c.author_id,
            c.parent_id,
            c.reply_to,
            c.status,
            c.created_date,
            c.updated_date,
            COALESCE(MAX(CASE WHEN md.metric_name = 'view_count' THEN cm.metric_value END), 0) as view_count,
            COALESCE((
                SELECT COUNT(*)
                FROM user_content_relations ucr
                WHERE ucr.content_id = c.content_id
                  AND ucr.relation_type_id = (SELECT type_id FROM relationship_types WHERE type_name = 'like')
            ), 0) as like_count,
            COALESCE(MAX(CASE WHEN md.metric_name = 'reply_count' THEN cm.metric_value END), 0) as reply_count
        FROM contents c
                 LEFT JOIN content_metrics cm ON c.content_id = cm.content_id
                 LEFT JOIN metric_definitions md ON cm.metric_id = md.metric_id
        WHERE c.content_type = 'post' AND c.status = 'active'
        GROUP BY c.content_id, c.content_type, c.title, c.body, c.body_plain,
                 c.author_id, c.parent_id, c.status, c.created_date, c.updated_date
        ORDER BY c.created_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ç»Ÿè®¡æ´»è·ƒå¸–å­æ•°é‡ -->
    <select id="countActivePosts" resultType="int">
        SELECT COUNT(*)
        FROM contents
        WHERE content_type = 'post' AND status = 'active'
    </select>

    <!-- æ ¹æ®ä½œè€…æŸ¥è¯¢å¸–å­ -->
    <select id="findPostsByAuthor" resultMap="ContentResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM contents
        WHERE author_id = #{authorId} AND content_type = 'post' AND status = 'active'
        ORDER BY created_date DESC
    </select>

    <!-- æœç´¢å¸–å­ -->
    <select id="searchPosts" resultMap="ContentResultMap">
        SELECT
            c.content_id,
            c.content_type,
            c.title,
            c.body,
            c.body_plain,
            c.author_id,
            c.parent_id,
            c.reply_to,
            c.status,
            c.created_date,
            c.updated_date,
            COALESCE(MAX(CASE WHEN md.metric_name = 'view_count' THEN cm.metric_value END), 0) as view_count,
            COALESCE((
                SELECT COUNT(*)
                FROM user_content_relations ucr
                WHERE ucr.content_id = c.content_id
                  AND ucr.relation_type_id = (SELECT type_id FROM relationship_types WHERE type_name = 'like')
            ), 0) as like_count,
            COALESCE(MAX(CASE WHEN md.metric_name = 'reply_count' THEN cm.metric_value END), 0) as reply_count
        FROM contents c
                 LEFT JOIN content_metrics cm ON c.content_id = cm.content_id
                 LEFT JOIN metric_definitions md ON cm.metric_id = md.metric_id
        WHERE c.content_type = 'post'
          AND c.status = 'active'
          AND (c.title ILIKE CONCAT('%', #{keyword}, '%')
            OR c.body_plain ILIKE CONCAT('%', #{keyword}, '%'))
        GROUP BY c.content_id, c.content_type, c.title, c.body, c.body_plain,
                 c.author_id, c.parent_id, c.status, c.created_date, c.updated_date
        ORDER BY c.created_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ç»Ÿè®¡æœç´¢ç»“æžœæ•°é‡ -->
    <select id="countSearchPosts" resultType="int">
        SELECT COUNT(*)
        FROM contents
        WHERE content_type = 'post'
          AND status = 'active'
          AND (
            title ILIKE CONCAT('%', #{keyword}, '%')
                OR body_plain ILIKE CONCAT('%', #{keyword}, '%')
            )
    </select>

    <!-- æŸ¥è¯¢å­å†…å®¹ -->
    <!-- æŸ¥è¯¢å­å†…å®¹ï¼ˆå›žå¤ï¼‰- å¸¦åˆ†é¡µå’Œç»Ÿè®¡æ•°æ® -->
    <select id="findChildren" resultMap="ContentResultMap">
        SELECT
            c.content_id,
            c.content_type,
            c.title,
            c.body,
            c.body_plain,
            c.author_id,
            c.parent_id,
            c.reply_to,
            c.status,
            c.created_date,
            c.updated_date,
            COALESCE((
                SELECT COUNT(*)
                FROM user_content_relations ucr
                WHERE ucr.content_id = c.content_id
                  AND ucr.relation_type_id = (SELECT type_id FROM relationship_types WHERE type_name = 'like')
            ), 0) as like_count
        FROM contents c
                 LEFT JOIN content_metrics cm ON c.content_id = cm.content_id
                 LEFT JOIN metric_definitions md ON cm.metric_id = md.metric_id
        WHERE c.parent_id = #{parentId}
          AND c.status = 'active'
        GROUP BY c.content_id, c.content_type, c.title, c.body, c.body_plain,
                 c.author_id, c.parent_id, c.status, c.created_date, c.updated_date
        ORDER BY c.created_date ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <!-- ç»Ÿè®¡å­å†…å®¹æ•°é‡ -->
    <select id="countChildren" resultType="int">
        SELECT COUNT(*)
        FROM contents
        WHERE parent_id = #{parentId} AND status = 'active'
    </select>

    <!-- æ ¹æ®ä½œè€…IDèŽ·å–å¸–å­åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ -->
    <select id="findByAuthorId" resultMap="ContentResultMap">
        SELECT
        content_id,
        title,
        body,
        author_id,
        parent_id,
        reply_to,  <!-- ðŸ”¥ æ–°å¢ž -->
        created_date,
        updated_date,
        status
        FROM contents
        WHERE author_id = #{authorId}
        ORDER BY created_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <!-- ç»Ÿè®¡ä½œè€…çš„å¸–å­æ€»æ•° -->
    <select id="countByAuthorId" resultType="int">
        SELECT COUNT(*)
        FROM contents
        WHERE author_id = #{authorId}
    </select>


    <!-- æŸ¥è¯¢ç”¨æˆ·çš„æ´»è·ƒå¸–å­ï¼ˆæœªåˆ é™¤ï¼‰ -->
    <select id="selectActiveByAuthorId" resultType="ForumContent">
        SELECT
            c.content_id,
            c.content_type,
            c.title,
            c.body,
            c.body_plain,
            c.author_id,
            c.parent_id,
            c.status,
            c.created_date,
            c.updated_date,
            COALESCE(MAX(CASE WHEN md.metric_name = 'view_count' THEN cm.metric_value END), 0) as view_count,
            COALESCE((
                SELECT COUNT(*)
                FROM user_content_relations ucr
                WHERE ucr.content_id = c.content_id
                  AND ucr.relation_type_id = (SELECT type_id FROM relationship_types WHERE type_name = 'like')
            ), 0) as like_count,
            COALESCE(MAX(CASE WHEN md.metric_name = 'reply_count' THEN cm.metric_value END), 0) as reply_count
        FROM contents c
                 LEFT JOIN content_metrics cm ON c.content_id = cm.content_id
                 LEFT JOIN metric_definitions md ON cm.metric_id = md.metric_id
        WHERE c.author_id = #{authorId}
          AND c.content_type = 'post'
          AND c.status = 'active'
        GROUP BY c.content_id, c.content_type, c.title, c.body, c.body_plain,
                 c.author_id, c.parent_id, c.status, c.created_date, c.updated_date
        ORDER BY c.created_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ç»Ÿè®¡ç”¨æˆ·çš„æ´»è·ƒå¸–å­æ•°ï¼ˆæœªåˆ é™¤ï¼‰ -->
    <select id="countActiveByAuthorId" resultType="int">
        SELECT COUNT(*)
        FROM contents
        WHERE author_id = #{authorId}
          AND content_type = 'post'
          AND status = 'active'
    </select>
</mapper>